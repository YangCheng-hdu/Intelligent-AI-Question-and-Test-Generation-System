# 考试系统后端演示文档

## 一、项目概述

本项目是一个基于Spring Boot的智能考试系统后端，主要功能包括AI驱动的题目生成、题库管理、试卷生成等。系统采用现代化的微服务架构设计，提供完整的RESTful API接口。

### 核心功能模块
- **AI题目生成模块**：基于智谱AI的智能题目生成与修改
- **题库管理模块**：题目的增删改查、分类管理
- **试卷生成模块**：智能组卷、分值分配
- **基础数据管理**：科目、题型等基础信息管理

## 二、技术架构与框架

### 2.1 核心技术栈

#### 后端框架
- **Spring Boot 3.5.3** - 主框架，提供自动配置和快速开发能力
- **Spring Data JPA** - 数据持久化层，简化数据库操作
- **Spring Security** - 安全框架，提供认证和授权
- **Spring WebFlux** - 响应式Web框架，支持异步非阻塞处理

#### 数据库
- **PostgreSQL** - 主数据库，存储题目、科目、题型等核心数据
- **Hibernate** - ORM框架，对象关系映射

#### 开发工具
- **Lombok** - 简化Java代码，自动生成getter/setter等
- **Jackson** - JSON序列化/反序列化
- **Maven** - 项目构建和依赖管理

#### AI集成
- **智谱AI API** - 提供题目生成和修改的AI能力
- **WebClient** - 响应式HTTP客户端，用于AI API调用

### 2.2 架构设计

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Controller    │    │    Service      │    │   Repository    │
│   (API层)       │───▶│   (业务层)      │───▶│   (数据层)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│      DTO        │    │     Entity      │    │   PostgreSQL    │
│   (数据传输)     │    │   (实体模型)     │    │    (数据库)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 三、API接口文档

### 3.1 题目管理API (QuestionController)

#### 基础路径: `/api/questions`

| HTTP方法 | 路径 | 功能描述 | 请求参数 | 响应格式 |
|---------|------|----------|----------|----------|
| POST | `/generate` | 生成题目 | QuestionGenerationRequest | List&lt;Question&gt; |
| POST | `/modify` | 修改题目 | QuestionModificationRequest | Question |
| PUT | `/edit` | 编辑题目 | QuestionEditRequest | Question |
| GET | `/bank` | 获取题库题目 | 无 | List&lt;Question&gt; |
| POST | `/save-to-bank` | 保存到题库 | List&lt;Long&gt; | String |
| DELETE | `/bank/{id}` | 从题库删除 | id(路径参数) | String |
| POST | `/{id}/add-to-exam` | 加入试卷 | id(路径参数) | Question |
| DELETE | `/{id}/remove-from-exam` | 从试卷移除 | id(路径参数) | String |
| GET | `/exam` | 获取试卷题目 | 无 | List&lt;Question&gt; |
| GET | `/{id}` | 根据ID获取题目 | id(路径参数) | Question |
| GET | `/bank/search` | 题库搜索 | subjectId, questionTypeId, keyword | List&lt;Question&gt; |

### 3.2 试卷管理API (ExamPaperController)

#### 基础路径: `/api/exam-paper`

| HTTP方法 | 路径 | 功能描述 | 请求参数 | 响应格式 |
|---------|------|----------|----------|----------|
| POST | `/generate` | 生成试卷 | ExamPaperGenerationRequest | ExamPaperResponse |
| GET | `/analyze-question-types` | 分析题型分布 | 无 | List&lt;QuestionTypeScore&gt; |

### 3.3 基础数据API

#### 科目管理 (SubjectController) - `/api/subjects`
| HTTP方法 | 路径 | 功能描述 |
|---------|------|----------|
| GET | `/` | 获取所有科目 |
| GET | `/{id}` | 根据ID获取科目 |

#### 题型管理 (QuestionTypeController) - `/api/question-types`
| HTTP方法 | 路径 | 功能描述 |
|---------|------|----------|
| GET | `/` | 获取所有题型 |
| GET | `/{id}` | 根据ID获取题型 |

## 四、代码实现详解 (QuestionServiceImpl重点分析)

### 4.1 服务层架构

QuestionServiceImpl是题目管理的核心业务实现类，负责处理所有与题目相关的业务逻辑。

<augment_code_snippet path="src/main/java/com/example/exambackend/service/impl/QuestionServiceImpl.java" mode="EXCERPT">
````java
@Service
@Transactional
public class QuestionServiceImpl implements QuestionService {
    
    @Autowired
    private QuestionRepository questionRepository;
    
    @Autowired
    private SubjectRepository subjectRepository;
    
    @Autowired
    private QuestionTypeRepository questionTypeRepository;
    
    @Autowired
    private AIService aiService;
````
</augment_code_snippet>

### 4.2 代表性API实现分析

#### API 1: 题目生成 (`/api/questions/generate`)

**完整处理流程：**

1. **Controller层接收请求**
<augment_code_snippet path="src/main/java/com/example/exambackend/controller/QuestionController.java" mode="EXCERPT">
````java
@PostMapping("/generate")
public ResponseEntity<?> generateQuestions(@RequestBody QuestionGenerationRequest request) {
    try {
        List<Question> questions = questionService.generateQuestions(request);
        return ResponseEntity.ok(questions);
    } catch (Exception e) {
        logger.error("生成题目失败: {}", e.getMessage(), e);
        Map<String, String> error = new HashMap<>();
        error.put("error", "生成题目失败: " + e.getMessage());
        return ResponseEntity.badRequest().body(error);
    }
}
````
</augment_code_snippet>

2. **Service层业务处理**
<augment_code_snippet path="src/main/java/com/example/exambackend/service/impl/QuestionServiceImpl.java" mode="EXCERPT">
````java
@Override
public List<Question> generateQuestions(QuestionGenerationRequest request) {
    // 1. 验证科目和题型
    Subject subject = subjectRepository.findById(request.getSubjectId())
            .orElseThrow(() -> new RuntimeException("科目不存在"));
    QuestionType questionType = questionTypeRepository.findById(request.getQuestionTypeId())
            .orElseThrow(() -> new RuntimeException("题型不存在"));
    
    // 2. 调用AI服务生成题目
    List<String> aiQuestions = aiService.generateQuestions(request);
    
    // 3. 解析并保存题目
    List<Question> questions = new ArrayList<>();
    for (String aiQuestion : aiQuestions) {
        QuestionContent content = parseQuestionContent(aiQuestion);
        Question question = createQuestionEntity(content, subject, questionType, request.getDifficulty());
        questions.add(questionRepository.save(question));
    }
    
    return questions;
}
````
</augment_code_snippet>

**输入数据格式 (QuestionGenerationRequest):**
```json
{
    "subjectId": 1,
    "questionTypeId": 2,
    "difficulty": "中等",
    "count": 5,
    "requirements": "重点考查函数的性质和图像"
}
```

**输出数据格式 (List&lt;Question&gt;):**
```json
[
    {
        "id": 1,
        "content": "已知函数f(x)=x²+2x-3，求f(x)的对称轴",
        "answer": "x=-1",
        "analysis": "二次函数的对称轴公式为x=-b/2a...",
        "difficulty": "中等",
        "subject": {"id": 1, "name": "数学"},
        "questionType": {"id": 2, "name": "解答题"},
        "isInBank": false,
        "isInExam": false
    }
]
```

#### API 2: 试卷生成 (`/api/exam-paper/generate`)

**完整处理流程：**

1. **Controller层路由**
<augment_code_snippet path="src/main/java/com/example/exambackend/controller/ExamPaperController.java" mode="EXCERPT">
````java
@PostMapping("/generate")
public ResponseEntity<ExamPaperResponse> generateExamPaper(@RequestBody ExamPaperGenerationRequest request) {
    try {
        ExamPaperResponse response = questionService.generateExamPaper(request);
        return ResponseEntity.ok(response);
    } catch (Exception e) {
        return ResponseEntity.badRequest().build();
    }
}
````
</augment_code_snippet>

2. **Service层核心逻辑**
<augment_code_snippet path="src/main/java/com/example/exambackend/service/impl/QuestionServiceImpl.java" mode="EXCERPT">
````java
@Override
public ExamPaperResponse generateExamPaper(ExamPaperGenerationRequest request) {
    // 1. 获取待生成试卷的题目
    List<Question> examQuestions = getExamQuestions();
    
    // 2. 根据分值分配策略生成试卷
    List<ExamQuestion> examQuestionList;
    if (request.getQuestionTypeScores() != null && !request.getQuestionTypeScores().isEmpty()) {
        examQuestionList = generateExamWithCustomScores(examQuestions, request.getQuestionTypeScores());
    } else {
        examQuestionList = generateExamWithEqualScores(examQuestions, request.getTotalScore());
    }
    
    // 3. 构建试卷响应
    ExamPaperResponse response = new ExamPaperResponse();
    response.setTitle(request.getTitle());
    response.setSubject(request.getSubject());
    response.setTotalScore(request.getTotalScore());
    response.setDuration(request.getDuration());
    response.setQuestions(examQuestionList);
    
    // 4. 清空待生成试卷状态
    for (Question q : examQuestions) {
        q.setIsInExam(false);
        questionRepository.save(q);
    }
    
    return response;
}
````
</augment_code_snippet>

### 4.3 数据模型设计

#### Question实体类
<augment_code_snippet path="src/main/java/com/example/exambackend/entity/Question.java" mode="EXCERPT">
````java
@Entity
@Table(name = "questions")
@Data
public class Question {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "subject_id")
    private Subject subject;
    
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "question_type_id")
    private QuestionType questionType;
    
    @Column(columnDefinition = "TEXT")
    private String content;
    
    @Column(columnDefinition = "TEXT")
    private String answer;
    
    @Column(columnDefinition = "TEXT")
    private String analysis;
    
    private String difficulty;
    private Boolean isInBank = false;
    private Boolean isInExam = false;
    
    @CreationTimestamp
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    private LocalDateTime updatedAt;
}
````
</augment_code_snippet>

## 五、总结

本考试系统后端采用了现代化的Spring Boot微服务架构，通过清晰的分层设计实现了高内聚低耦合的代码结构。QuestionServiceImpl作为核心业务层，完整实现了从AI题目生成到试卷组装的全流程处理，展现了良好的工程实践和代码质量。

### 技术亮点
1. **响应式编程**：使用WebFlux支持高并发AI API调用
2. **智能解析**：自动解析AI生成的题目内容并结构化存储
3. **灵活组卷**：支持多种分值分配策略的智能试卷生成
4. **完整的错误处理**：统一的异常处理和错误响应机制
